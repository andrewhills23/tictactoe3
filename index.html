<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Tic Tac ToeÂ³</title>

<link href="https://fonts.googleapis.com/css2?family=Libre+Franklin:wght@400;500;600&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet" />

<style>
  :root {
    --bg-color: #fbfbfb;
    --board-bg: #ffffff;
    --nyt-black: #121212;
    --highlight-blue: #a7d8ff;
    --legal-move-gold: #fce48f; 
    --dimmed-cell: #fcfcfc;
    
    /* Grid Line Colors */
    --line-thin: #e6e6e6;
    --line-med: #888;
    --line-thick: #000;
  }

  body {
    margin: 0;
    height: 100vh;
    background: var(--bg-color);
    font-family: 'Libre Franklin', sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    color: var(--nyt-black);
    overflow: hidden; 
  }

  /* ---------------- BUTTONS ---------------- */
  .pill-btn {
    background: var(--nyt-black);
    color: white;
    padding: 16px 40px;
    border: none;
    border-radius: 40px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    font-family: 'Libre Franklin', sans-serif;
    transition: transform 0.2s, box-shadow 0.2s;
    min-width: 200px;
  }
  .pill-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.15); }
  
  .secondary-btn {
    background: transparent;
    color: var(--nyt-black);
    border: 2px solid #e0e0e0;
  }
  .secondary-btn:hover { background: #eee; transform: translateY(-2px); border-color: #ccc; }

  .disabled-btn { opacity: 0.5; cursor: not-allowed; background: #ccc; pointer-events: none; }

  /* ---------------- SCREENS ---------------- */
  .screen {
    position: absolute; inset: 0;
    background: var(--bg-color);
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    z-index: 100; transition: opacity 0.4s ease;
  }
  .hidden { opacity: 0; pointer-events: none; z-index: -1; }

  #title {
    font-family: 'Playfair Display', serif; font-size: 5rem;
    font-weight: 900; color: var(--nyt-black); letter-spacing: -0.03em; margin-bottom: 10px;
  }
  #title sup {
    /* CHANGED: Matched font to Playfair Display */
    font-family: 'Playfair Display', serif;
    font-size: 2rem;
    font-weight: 900; 
    top: -2.5rem; 
    position: relative; 
    color: var(--nyt-black);
  }

  #mode-screen h2 { font-family: 'Playfair Display', serif; font-size: 3rem; margin-bottom: 40px; }
  .mode-options { display: flex; flex-direction: column; gap: 20px; align-items: center; }

  /* ---------------- WIN MODAL ---------------- */
  .modal-overlay {
    position: absolute; inset: 0;
    background: rgba(255,255,255,0.95); backdrop-filter: blur(5px);
    z-index: 2000;
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    opacity: 0; pointer-events: none; transition: opacity 0.3s;
  }
  .modal-overlay.active { opacity: 1; pointer-events: auto; }

  #win-title { font-family: 'Playfair Display', serif; font-size: 6rem; font-weight: 900; margin-bottom: 20px; }

  /* ---------------- GAME BOARD & GRID SYSTEM ---------------- */
  #game-wrapper {
    display: flex; gap: 40px; align-items: flex-start; padding-top: 20px;
    opacity: 0; transition: opacity 0.6s ease;
  }

  #board-container {
    position: relative;
    width: 88vmin; 
    height: 88vmin;
  }

  /* The Grid */
  #board {
    width: 100%; height: 100%;
    display: grid;
    grid-template-columns: repeat(27, 1fr);
    grid-template-rows: repeat(27, 1fr);
    background: var(--board-bg);
    /* The outer border of the whole board */
    border: 4px solid var(--nyt-black); 
    box-sizing: border-box;
  }

  /* --- NEW BORDER LOGIC FOR CELLS --- */
  .cell {
    /* Base borders (Thin) */
    border-right: 1px solid var(--line-thin);
    border-bottom: 1px solid var(--line-thin);
    
    font-family: 'Libre Franklin', sans-serif;
    font-size: calc(88vmin / 27 * 0.6);
    font-weight: 600;
    display: flex; justify-content: center; align-items: center;
    cursor: pointer; user-select: none;
    transition: background 0.1s; color: var(--nyt-black);
    box-sizing: border-box;
  }

  /* Medium Lines (Every 3rd cell) */
  .cell.b-right-med { border-right: 1px solid var(--line-med); }
  .cell.b-bottom-med { border-bottom: 1px solid var(--line-med); }

  /* Thick Lines (Every 9th cell) */
  .cell.b-right-thick { border-right: 3px solid var(--line-thick); }
  .cell.b-bottom-thick { border-bottom: 3px solid var(--line-thick); }

  /* Clean up edges */
  .cell[data-col="26"] { border-right: none !important; }
  .cell[data-row="26"] { border-bottom: none !important; }

  /* Cell States */
  .cell.legal-zone { background: var(--legal-move-gold); }
  .cell.legal-zone:hover { background: #fccd55; }
  .cell.disabled-zone { background: var(--dimmed-cell); cursor: default; }
  .cell.x-mark { color: #d93a3a; }
  .cell.o-mark { color: #3a7bd9; }

  /* --- LABELS --- */
  .label-strip {
    position: absolute;
    display: grid;
    font-size: 0.65rem;
    color: #999;
    font-weight: 500;
    pointer-events: none;
  }

  #col-labels {
    top: -20px; left: 0; width: 100%; height: 20px;
    grid-template-columns: repeat(27, 1fr);
    align-items: end; justify-items: center;
    padding-bottom: 4px; box-sizing: border-box;
  }

  #row-labels {
    left: -25px; top: 0; height: 100%; width: 25px;
    grid-template-rows: repeat(27, 1fr);
    align-items: center; justify-items: end;
    padding-right: 6px; box-sizing: border-box;
  }

  /* Won Overlay */
  .won-overlay {
    position: absolute; display: flex; justify-content: center; align-items: center;
    font-family: 'Playfair Display', serif; font-weight: 900;
    animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); pointer-events: none;
  }
  .won-middle-grid { font-size: 3rem; z-index: 6; background: rgba(255, 255, 255, 0.85); }
  .won-big-grid { font-size: 10rem; z-index: 7; background: rgba(255, 255, 255, 0.92); border: 2px solid var(--nyt-black); }
  .winner-X { color: #d93a3a; }
  .winner-O { color: #3a7bd9; }

  @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }

  /* ---------------- SIDEBAR ---------------- */
  #sidebar {
    width: 220px; height: 88vmin;
    padding: 30px 20px; box-sizing: border-box;
    background: white; border: 1px solid #ccc;
    display: flex; flex-direction: column; align-items: center;
    position: relative;
  }
  
  #turn-display-container {
    width: 100%; border-bottom: 1px solid #eee; padding-bottom: 20px;
    text-align: center; margin-bottom: 10px;
  }
  
  .label-text {
    font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px;
    font-weight: 700; color: #888; margin-bottom: 10px;
  }
  
  #big-mark { font-family: 'Playfair Display', serif; font-size: 5rem; line-height: 1; font-weight: 900; }
  .turn-x #big-mark { color: #d93a3a; }
  .turn-o #big-mark { color: #3a7bd9; }

  #log-wrapper {
    width: 100%;
    flex-grow: 1;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    margin-top: 10px;
    /* REMOVED: margin-bottom for help button */
  }

  #activity-log {
    width: 100%;
    overflow-y: auto;
    padding-right: 4px;
    scrollbar-width: thin;
    scrollbar-color: #ddd transparent;
  }
  #activity-log::-webkit-scrollbar { width: 4px; }
  #activity-log::-webkit-scrollbar-thumb { background-color: #ddd; border-radius: 4px; }

  .log-entry {
    font-size: 0.85rem;
    color: #555;
    padding: 8px 0;
    border-bottom: 1px solid #f5f5f5;
    animation: slideIn 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  @keyframes slideIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

  .log-mark { font-weight: 800; font-family: 'Playfair Display', serif; font-size: 0.9rem; }
  .log-x { color: #d93a3a; }
  .log-o { color: #3a7bd9; }
</style>
</head>
<body>

<div id="start-screen" class="screen">
  <div id="title">Tic Tac Toe<sup>3</sup></div>
  <button id="main-play-btn" class="pill-btn">Play</button>
</div>

<div id="mode-screen" class="screen hidden">
  <h2>Select Mode</h2>
  <div class="mode-options">
    <button id="friend-mode-btn" class="pill-btn">Play a Friend</button>
    <button class="pill-btn disabled-btn">Play Computer (Soon)</button>
  </div>
</div>

<div id="win-screen" class="modal-overlay">
  <div class="label-text">Winner</div>
  <div id="win-title">X Wins!</div>
  <div style="display:flex; gap: 20px;">
    <button id="play-again-btn" class="pill-btn">Play Again</button>
    <button id="view-board-btn" class="pill-btn secondary-btn">View Board</button>
  </div>
</div>

<div id="game-wrapper">
  
  <div id="board-container">
    <div id="col-labels" class="label-strip"></div>
    <div id="row-labels" class="label-strip"></div>
    <div id="board"></div>
  </div>
  
  <div id="sidebar">
    <div id="turn-display-container" class="turn-x">
      <div class="label-text">Current Turn</div>
      <div id="big-mark">X</div>
    </div>

    <div id="log-wrapper">
      <div class="label-text" style="text-align: left; border-bottom: 1px solid #eee; padding-bottom: 5px;">Move History</div>
      <div id="activity-log"></div>
    </div>
    
    </div>
</div>

<script>
/* --- DOM ELEMENTS --- */
const startScreen = document.getElementById("start-screen");
const modeScreen = document.getElementById("mode-screen");
const winScreen = document.getElementById("win-screen");
// REMOVED: helpModal
const gameWrapper = document.getElementById("game-wrapper");
const board = document.getElementById("board");
const colLabels = document.getElementById("col-labels");
const rowLabels = document.getElementById("row-labels");
const mainPlayBtn = document.getElementById("main-play-btn");
const friendModeBtn = document.getElementById("friend-mode-btn");
const playAgainBtn = document.getElementById("play-again-btn");
const viewBoardBtn = document.getElementById("view-board-btn");
// REMOVED: helpBtn, closeHelpBtn
const turnContainer = document.getElementById("turn-display-container");
const bigMark = document.getElementById("big-mark");
const winTitle = document.getElementById("win-title");
const activityLog = document.getElementById("activity-log");

/* --- STATE --- */
let turn = "X";
let nextMoveConstraint = null; 
let isGameOver = false;
const cells = [];
let middleGridState = new Array(81).fill(null);
let bigGridState = new Array(9).fill(null);

/* --- NAVIGATION --- */
mainPlayBtn.addEventListener("click", () => {
  startScreen.classList.add("hidden");
  modeScreen.classList.remove("hidden");
});

friendModeBtn.addEventListener("click", () => {
  modeScreen.classList.add("hidden");
  setTimeout(() => {
    gameWrapper.style.opacity = "1";
    updateBoardVisuals(); 
  }, 200);
});

// REMOVED: Help button event listeners

playAgainBtn.addEventListener("click", resetGame);
viewBoardBtn.addEventListener("click", () => winScreen.classList.remove("active"));

/* --- INIT BOARD & LABELS --- */
// 1. Create Grid
for (let i = 0; i < 27 * 27; i++) {
  const cell = document.createElement("div");
  cell.className = "cell legal-zone"; 
  cell.dataset.index = i;
  const row = Math.floor(i / 27);
  const col = i % 27;
  cell.dataset.row = row;
  cell.dataset.col = col;

  // Apply Grid Line Logic
  // Right Borders
  if ((col + 1) % 9 === 0) cell.classList.add("b-right-thick");
  else if ((col + 1) % 3 === 0) cell.classList.add("b-right-med");

  // Bottom Borders
  if ((row + 1) % 9 === 0) cell.classList.add("b-bottom-thick");
  else if ((row + 1) % 3 === 0) cell.classList.add("b-bottom-med");

  board.appendChild(cell);
  cells.push(cell);
  cell.addEventListener("click", () => handleMove(cell, row, col));
}

// 2. Create Labels
for (let i = 1; i <= 27; i++) {
  const colNum = document.createElement("div"); colNum.textContent = i; colLabels.appendChild(colNum);
  const rowNum = document.createElement("div"); rowNum.textContent = i; rowLabels.appendChild(rowNum);
}

/* --- LOGIC CORE --- */
function handleMove(cell, row, col) {
  if (isGameOver) return;
  // REMOVED: helpModal check
  if (cell.textContent !== "") return;
  if (!isMoveLegal(row, col)) return;

  addLogEntry(turn, row, col);

  cell.textContent = turn;
  applyMarkStyles(cell);

  let wonSomething = false;
  if (checkMiddleGridWin(row, col)) {
    wonSomething = true;
    const mgRow = Math.floor(row / 3);
    const mgCol = Math.floor(col / 3);
    const bgRow = Math.floor(mgRow / 3);
    const bgCol = Math.floor(mgCol / 3);
    if (checkBigGridWin(bgRow, bgCol)) checkGlobalWin();
  }

  if (isGameOver) { updateBoardVisuals(); return; }
  
  if (wonSomething) nextMoveConstraint = null; 
  else calculateNextConstraint(row, col);

  switchTurn();
  updateBoardVisuals();
}

function addLogEntry(player, r, c) {
  const entry = document.createElement("div");
  entry.className = "log-entry";
  // X Coordinate (Col), Y Coordinate (Row)
  const x = c + 1;
  const y = r + 1;
  
  const markSpan = `<span class="log-mark ${player === 'X' ? 'log-x' : 'log-o'}">${player}</span>`;
  entry.innerHTML = `${markSpan} placed at <strong>(${x}, ${y})</strong>`;
  
  activityLog.insertBefore(entry, activityLog.firstChild);
}

/* --- VALIDATION & WIN CHECKING (Standard) --- */
function isMoveLegal(r, c) {
  if (isGameOver) return false;
  const mgRow = Math.floor(r / 3);
  const mgCol = Math.floor(c / 3);
  const mgIndex = mgRow * 9 + mgCol;
  const bgRow = Math.floor(mgRow / 3);
  const bgCol = Math.floor(mgCol / 3);
  const bgIndex = bgRow * 3 + bgCol;

  if (middleGridState[mgIndex] !== null) return false;
  if (bigGridState[bgIndex] !== null) return false;

  if (!nextMoveConstraint) return true;
  const { r: rRange, c: cRange } = nextMoveConstraint;
  return (r >= rRange[0] && r < rRange[1] && c >= cRange[0] && c < cRange[1]);
}

function checkMiddleGridWin(r, c) {
  const mgRow = Math.floor(r / 3);
  const mgCol = Math.floor(c / 3);
  const mgIndex = mgRow * 9 + mgCol;
  if (middleGridState[mgIndex] !== null) return false;

  const startR = mgRow * 3;
  const startC = mgCol * 3;
  const getCell = (dr, dc) => cells[(startR + dr) * 27 + (startC + dc)].textContent;

  const winner = checkGridLogic(getCell);
  if (winner) {
    middleGridState[mgIndex] = winner;
    createOverlay(mgRow, mgCol, winner, "middle");
    return true;
  }
  return false;
}

function checkBigGridWin(bgRow, bgCol) {
  const bgIndex = bgRow * 3 + bgCol;
  if (bigGridState[bgIndex] !== null) return false;
  const startMgRow = bgRow * 3;
  const startMgCol = bgCol * 3;
  const getMgOwner = (dr, dc) => middleGridState[(startMgRow + dr) * 9 + (startMgCol + dc)];
  const winner = checkGridLogic(getMgOwner);
  if (winner) {
    bigGridState[bgIndex] = winner;
    createOverlay(bgRow, bgCol, winner, "big");
    return true;
  }
  return false;
}

function checkGlobalWin() {
  const getBgOwner = (dr, dc) => bigGridState[dr * 3 + dc];
  const winner = checkGridLogic(getBgOwner);
  if (winner) {
    isGameOver = true;
    winTitle.textContent = `${winner} Wins!`;
    winTitle.className = winner === "X" ? "winner-X" : "winner-O";
    winScreen.classList.add("active");
  }
}

function checkGridLogic(accessorFn) {
  const lines = [
    [[0,0], [0,1], [0,2]], [[1,0], [1,1], [1,2]], [[2,0], [2,1], [2,2]], 
    [[0,0], [1,0], [2,0]], [[0,1], [1,1], [2,1]], [[0,2], [1,2], [2,2]], 
    [[0,0], [1,1], [2,2]], [[0,2], [1,1], [2,0]] 
  ];
  for (let line of lines) {
    const v0 = accessorFn(line[0][0], line[0][1]);
    const v1 = accessorFn(line[1][0], line[1][1]);
    const v2 = accessorFn(line[2][0], line[2][1]);
    if (v0 && v0 === v1 && v0 === v2) return v0;
  }
  return null;
}

/* --- HELPERS --- */
function calculateNextConstraint(lastRow, lastCol) {
  const middleGridRowVal = Math.floor((lastRow % 9) / 3);
  const middleGridColVal = Math.floor((lastCol % 9) / 3);
  const cellRowVal = lastRow % 3;
  const cellColVal = lastCol % 3;
  const targetBigRow = middleGridRowVal;
  const targetBigCol = middleGridColVal;
  const targetMidRow = cellRowVal;
  const targetMidCol = cellColVal;
  const startRow = (targetBigRow * 9) + (targetMidRow * 3);
  const startCol = (targetBigCol * 9) + (targetMidCol * 3);
  
  const targetMgRow = (targetBigRow * 3) + targetMidRow;
  const targetMgCol = (targetBigCol * 3) + targetMidCol;
  const targetMgIndex = targetMgRow * 9 + targetMgCol;
  const targetBgIndex = targetBigRow * 3 + targetBigCol;

  nextMoveConstraint = { r: [startRow, startRow + 3], c: [startCol, startCol + 3] };

  if (middleGridState[targetMgIndex] !== null) { nextMoveConstraint = null; return; }
  if (bigGridState[targetBgIndex] !== null) { nextMoveConstraint = null; return; }
  if (isZoneFull(nextMoveConstraint)) { nextMoveConstraint = null; }
}

function isZoneFull(constraint) {
  for (let r = constraint.r[0]; r < constraint.r[1]; r++) {
    for (let c = constraint.c[0]; c < constraint.c[1]; c++) {
      if (cells[r * 27 + c].textContent === "") return false;
    }
  }
  return true;
}

function updateBoardVisuals() {
  cells.forEach(cell => {
    const r = parseInt(cell.dataset.row);
    const c = parseInt(cell.dataset.col);
    if (isGameOver || cell.textContent !== "") {
      cell.className = "cell"; 
      if(cell.textContent) applyMarkStyles(cell);
      restoreBorders(cell, r, c);
    } else if (isMoveLegal(r, c)) {
      cell.className = "cell legal-zone";
      restoreBorders(cell, r, c);
    } else {
      cell.className = "cell disabled-zone";
      restoreBorders(cell, r, c);
    }
  });
}

function restoreBorders(cell, r, c) {
  if ((c + 1) % 9 === 0) cell.classList.add("b-right-thick");
  else if ((c + 1) % 3 === 0) cell.classList.add("b-right-med");
  
  if ((r + 1) % 9 === 0) cell.classList.add("b-bottom-thick");
  else if ((r + 1) % 3 === 0) cell.classList.add("b-bottom-med");
}

function switchTurn() {
  turn = turn === "X" ? "O" : "X";
  bigMark.textContent = turn;
  turnContainer.className = turn === "X" ? "turn-x" : "turn-o";
}

function applyMarkStyles(cell) {
  cell.classList.remove("x-mark", "o-mark");
  if (cell.textContent === "X") cell.classList.add("x-mark");
  if (cell.textContent === "O") cell.classList.add("o-mark");
}

function createOverlay(row, col, winner, type) {
  const overlay = document.createElement("div");
  overlay.className = `won-overlay winner-${winner}`;
  overlay.textContent = winner;
  if (type === "middle") {
    overlay.classList.add("won-middle-grid");
    const sizePct = 100 / 9; 
    overlay.style.width = `${sizePct}%`; overlay.style.height = `${sizePct}%`;
    overlay.style.top = `${row * sizePct}%`; overlay.style.left = `${col * sizePct}%`;
  } else {
    overlay.classList.add("won-big-grid");
    const sizePct = 100 / 3; 
    overlay.style.width = `${sizePct}%`; overlay.style.height = `${sizePct}%`;
    overlay.style.top = `${row * sizePct}%`; overlay.style.left = `${col * sizePct}%`;
  }
  board.appendChild(overlay);
}

function resetGame() {
  turn = "X";
  nextMoveConstraint = null;
  isGameOver = false;
  middleGridState.fill(null);
  bigGridState.fill(null);
  
  cells.forEach(cell => {
    cell.textContent = "";
    cell.className = "cell legal-zone";
    const r = parseInt(cell.dataset.row);
    const c = parseInt(cell.dataset.col);
    restoreBorders(cell, r, c);
  });
  
  document.querySelectorAll(".won-overlay").forEach(o => o.remove());
  activityLog.innerHTML = "";
  winScreen.classList.remove("active");
  bigMark.textContent = "X";
  turnContainer.className = "turn-x";
  updateBoardVisuals();
}
</script>

</body>
</html>

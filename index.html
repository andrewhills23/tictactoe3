<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Tic Tac ToeÂ³</title>

<link href="https://fonts.googleapis.com/css2?family=Libre+Franklin:wght@400;500;600&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet" />

<style>
  :root {
    /* LIGHT THEME (Default) */
    --bg-color: #fbfbfb;
    --board-bg: #ffffff;
    --nyt-black: #121212;
    --highlight-blue: #a7d8ff;
    --legal-move-gold: #fff0bf; 
    --dimmed-cell: #fcfcfc;
    --line-thin: #e6e6e6;
    --line-med: #888;
    --line-thick: #000;
    --text-subtle: #666;
    --btn-hover: #f0f0f0;
    
    /* Font Variables */
    --font-title: 'Playfair Display', serif;
    --font-ui: 'Libre Franklin', sans-serif;
    
    /* Glows (Default none) */
    --glow-text: none;
    --glow-box: none;
  }

  /* DARK THEME OVERRIDES */
  body.dark-theme {
    --bg-color: #121212;
    --board-bg: #1e1e1e;
    --nyt-black: #e0e0e0;
    --highlight-blue: #2a4b70;
    --legal-move-gold: #3d3b36; 
    --dimmed-cell: #252525;
    --line-thin: #333;
    --line-med: #555;
    --line-thick: #e0e0e0;
    --text-subtle: #aaa;
    --btn-hover: #333;
  }

  /* STRANGER THINGS THEME */
  body.stranger-theme {
    --bg-color: #080000;
    --board-bg: #000000;
    --nyt-black: #ff1e1e; /* Neon Red */
    --highlight-blue: #222; 
    --legal-move-gold: #2a0000; 
    --dimmed-cell: #110000;
    --line-thin: #550000;
    --line-med: #aa0000;
    --line-thick: #ff0000;
    --text-subtle: #990000;
    --btn-hover: #1a0000;
    
    /* Glowing Effects */
    --glow-text: 0 0 8px rgba(255, 30, 30, 0.6);
    --glow-box: 0 0 15px rgba(255, 0, 0, 0.4);
  }

  /* SHOWGIRL THEME */
  body.showgirl-theme {
    --bg-color: #fff3e0; /* Muted Orange Creamsicle */
    --board-bg: #fffbf0;
    --nyt-black: #e65100; /* Burnt Orange Borders */
    --highlight-blue: #00c897; /* Greenish Teal accent */
    --legal-move-gold: #ffe0b2; /* Pale Orange */
    --dimmed-cell: #fff8ec;
    --line-thin: #ffcc80;
    --line-med: #ff9800;
    --line-thick: #e65100;
    --text-subtle: #bf360c;
    --btn-hover: #ffe0b2;
    
    --glow-text: 0 0 5px rgba(255, 160, 0, 0.4);
    --glow-box: 0 0 12px rgba(255, 160, 0, 0.3);
    
    /* GLITTER BACKGROUND (Noise Texture) */
    background-image:
        radial-gradient(rgba(255, 183, 77, 0.6) 1px, transparent 1px),
        radial-gradient(rgba(255, 224, 178, 0.6) 1px, transparent 1px),
        radial-gradient(rgba(255, 152, 0, 0.4) 1.5px, transparent 1.5px);
    background-size: 4px 4px, 6px 6px, 10px 10px;
    background-position: 0 0, 3px 3px, 1px 5px;
    background-attachment: fixed;
  }
  
  /* Add texture to board backgrounds for showgirl theme */
  body.showgirl-theme #board,
  body.showgirl-theme .screen,
  body.showgirl-theme #sidebar {
      background-image: inherit; 
      background-size: inherit;
      background-color: rgba(255,255,255,0.94);
      background-blend-mode: overlay;
  }

  body {
    margin: 0;
    height: 100vh;
    background: var(--bg-color);
    font-family: var(--font-ui); 
    display: flex;
    justify-content: center;
    align-items: center;
    color: var(--nyt-black);
    overflow: hidden; 
    transition: background 0.3s, color 0.3s;
  }

  /* ---------------- BUTTONS ---------------- */
  .pill-btn {
    background: var(--nyt-black);
    color: var(--bg-color);
    padding: 16px 40px;
    border: none;
    border-radius: 40px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    font-family: var(--font-ui);
    transition: transform 0.2s, box-shadow 0.2s, background 0.3s;
    min-width: 200px;
    box-shadow: var(--glow-box);
    position: relative; z-index: 1;
  }
  .pill-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.15); }
  
  .secondary-btn {
    background: transparent;
    color: var(--nyt-black);
    border: 2px solid var(--line-med);
    box-shadow: none; 
  }
  .secondary-btn:hover { background: var(--btn-hover); transform: translateY(-2px); border-color: var(--nyt-black); }

  .action-btn {
    width: 100%;
    padding: 10px;
    margin-top: 8px;
    border: 1px solid var(--line-med);
    background: var(--board-bg);
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--nyt-black);
    transition: all 0.2s;
    font-family: var(--font-ui);
  }
  .action-btn:hover { background: var(--btn-hover); border-color: var(--nyt-black); }
  .danger-btn:hover { background: #500; color: white; border-color: #d93a3a; }

  /* ---------------- SCREENS ---------------- */
  .screen {
    position: absolute; inset: 0;
    background: var(--bg-color);
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    z-index: 100; transition: opacity 0.4s ease;
  }
  .hidden { opacity: 0; pointer-events: none; z-index: -1; }

  #title {
    font-family: var(--font-title); 
    font-size: 5rem;
    font-weight: 900; 
    color: var(--nyt-black); 
    letter-spacing: -0.03em; 
    margin-bottom: 10px;
    text-shadow: var(--glow-text); 
  }
  #title sup {
    font-family: var(--font-title);
    font-size: 2rem;
    font-weight: 900; 
    top: -2.5rem; 
    position: relative; 
    color: var(--nyt-black);
    text-shadow: var(--glow-text);
  }

  #mode-screen h2, #settings-screen h2, #themes-screen h2 { 
    font-family: var(--font-title); 
    font-size: 3rem; margin-bottom: 40px; 
    text-shadow: var(--glow-text);
  }
  
  .mode-options { display: flex; flex-direction: column; gap: 15px; align-items: center; }

  /* ---------------- SETTINGS & THEMES ---------------- */
  .settings-group { margin-bottom: 30px; text-align: center; }
  .settings-label {
    font-weight: 700; text-transform: uppercase; font-size: 0.8rem;
    letter-spacing: 1px; color: var(--text-subtle); margin-bottom: 15px; display: block;
    text-shadow: var(--glow-text);
  }
  .option-row { display: flex; gap: 10px; justify-content: center; margin-bottom: 10px; }

  .select-btn {
    background: var(--board-bg); 
    border: 1px solid var(--line-med); 
    color: var(--nyt-black);
    padding: 12px 24px;
    border-radius: 8px; cursor: pointer; font-family: var(--font-ui);
    font-weight: 600; transition: all 0.2s; min-width: 80px;
  }
  .select-btn:hover { border-color: var(--nyt-black); }
  .select-btn.selected { background: var(--nyt-black); color: var(--bg-color); border-color: var(--nyt-black); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
  
  #btn-side-x.selected { background: #d93a3a; border-color: #d93a3a; color: white; }
  #btn-side-o.selected { background: #3a7bd9; border-color: #3a7bd9; color: white; }
  
  body.showgirl-theme #btn-side-x.selected { background: #00c897; border-color: #00c897; } 
  body.showgirl-theme #btn-side-o.selected { background: #ff9100; border-color: #ff9100; }

  /* ---------------- MODALS ---------------- */
  .modal-overlay {
    position: absolute; inset: 0;
    background: rgba(255,255,255,0.9); backdrop-filter: blur(5px);
    z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center;
    opacity: 0; pointer-events: none; transition: opacity 0.3s;
  }
  
  body.dark-theme .modal-overlay, body.stranger-theme .modal-overlay {
    background: rgba(0,0,0,0.9);
  }
  body.showgirl-theme .modal-overlay {
    background: rgba(255, 243, 224, 0.95);
  }

  .modal-overlay.active { opacity: 1; pointer-events: auto; }

  #win-title { 
    font-family: var(--font-title); font-size: 6rem; font-weight: 900; margin-bottom: 20px; 
    text-shadow: var(--glow-text);
  }
  
  .big-pause-icon {
    width: 80px; height: 80px; display: flex; justify-content: center; align-items: center; margin-bottom: 10px; color: var(--nyt-black);
    filter: drop-shadow(var(--glow-text));
  }
  .big-pause-icon::after {
    content: ''; display: block; width: 15px; height: 50px; background-color: currentColor; box-shadow: 25px 0 0 0 currentColor; transform: translateX(-12px);
  }
  #paused-time {
    font-family: var(--font-ui); font-size: 2.5rem; font-weight: 600; margin-top: 10px; font-variant-numeric: tabular-nums; color: var(--nyt-black);
    text-shadow: var(--glow-text);
  }

  /* ---------------- BOARD ---------------- */
  #game-wrapper {
    display: flex; gap: 40px; align-items: flex-start; padding-top: 20px;
    opacity: 0; transition: opacity 0.6s ease;
  }
  #board-container { position: relative; width: 88vmin; height: 88vmin; }
  
  #board {
    width: 100%; height: 100%; display: grid;
    grid-template-columns: repeat(27, 1fr); grid-template-rows: repeat(27, 1fr);
    background: var(--board-bg); border: 4px solid var(--nyt-black); box-sizing: border-box;
    transition: background 0.3s, border-color 0.3s;
    box-shadow: var(--glow-box); 
  }
  
  .cell {
    border-right: 1px solid var(--line-thin); border-bottom: 1px solid var(--line-thin);
    font-family: var(--font-ui); font-size: calc(88vmin / 27 * 0.6);
    font-weight: 600; display: flex; justify-content: center; align-items: center;
    cursor: pointer; user-select: none; transition: background 0.1s; color: var(--nyt-black); box-sizing: border-box;
  }
  .cell.b-right-med { border-right: 1px solid var(--line-med); }
  .cell.b-bottom-med { border-bottom: 1px solid var(--line-med); }
  .cell.b-right-thick { border-right: 3px solid var(--line-thick); }
  .cell.b-bottom-thick { border-bottom: 3px solid var(--line-thick); }
  .cell[data-col="26"] { border-right: none !important; }
  .cell[data-row="26"] { border-bottom: none !important; }

  .cell.legal-zone { background: var(--legal-move-gold); }
  .cell.legal-zone:hover { background: #f9d884; }
  
  /* THEME HOVER FIXES */
  body.dark-theme .cell.legal-zone:hover { background: #55534d; }
  body.stranger-theme .cell.legal-zone:hover { background: #400000; }
  body.showgirl-theme .cell.legal-zone:hover { background: #ffcc80; }
  
  .cell.disabled-zone { background: var(--dimmed-cell); cursor: default; }
  
  /* Marks */
  .cell.x-mark { color: #d93a3a; text-shadow: var(--glow-text); }
  .cell.o-mark { color: #3a7bd9; text-shadow: var(--glow-text); }
  
  /* Theme Specific Marks */
  body.stranger-theme .cell.x-mark { color: #ff0000; }
  body.stranger-theme .cell.o-mark { color: #ffffff; text-shadow: 0 0 5px white; }
  body.showgirl-theme .cell.x-mark { color: #00c897; }
  body.showgirl-theme .cell.o-mark { color: #ff9100; }
  
  .label-strip { position: absolute; display: grid; font-size: 0.65rem; color: var(--text-subtle); font-weight: 500; pointer-events: none; }
  #col-labels { top: -20px; left: 0; width: 100%; height: 20px; grid-template-columns: repeat(27, 1fr); align-items: end; justify-items: center; padding-bottom: 4px; box-sizing: border-box; }
  #row-labels { left: -25px; top: 0; height: 100%; width: 25px; grid-template-rows: repeat(27, 1fr); align-items: center; justify-items: end; padding-right: 6px; box-sizing: border-box; }

  .won-overlay {
    position: absolute; display: flex; justify-content: center; align-items: center;
    font-family: var(--font-title); font-weight: 900;
    animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); pointer-events: none;
  }
  .won-middle-grid { font-size: 3rem; z-index: 6; background: rgba(255, 255, 255, 0.85); }
  
  body.dark-theme .won-middle-grid, body.stranger-theme .won-middle-grid { background: rgba(20, 20, 20, 0.85); }
  body.showgirl-theme .won-middle-grid { background: rgba(255, 243, 224, 0.85); }
  
  .won-big-grid { font-size: 10rem; z-index: 7; background: rgba(255, 255, 255, 0.92); border: 2px solid var(--nyt-black); }
  body.dark-theme .won-big-grid, body.stranger-theme .won-big-grid { background: rgba(20, 20, 20, 0.92); }
  body.showgirl-theme .won-big-grid { background: rgba(255, 243, 224, 0.92); }

  .winner-X { color: #d93a3a; text-shadow: var(--glow-text); }
  .winner-O { color: #3a7bd9; text-shadow: var(--glow-text); }
  body.stranger-theme .winner-X { color: #ff0000; }
  body.stranger-theme .winner-O { color: #fff; }
  body.showgirl-theme .winner-X { color: #00c897; }
  body.showgirl-theme .winner-O { color: #ff9100; }

  @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }

  /* ---------------- SIDEBAR ---------------- */
  #sidebar {
    width: 220px; height: 88vmin;
    padding: 30px 20px; box-sizing: border-box;
    background: var(--board-bg); border: 1px solid var(--line-med);
    display: flex; flex-direction: column; align-items: center;
    position: relative;
    transition: background 0.3s;
    box-shadow: var(--glow-box);
  }
  
  #turn-display-container { width: 100%; border-bottom: 1px solid var(--line-thin); padding-bottom: 20px; text-align: center; margin-bottom: 10px; }
  .label-text { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; color: var(--text-subtle); margin-bottom: 10px; text-shadow: var(--glow-text); }
  #big-mark { font-family: var(--font-title); font-size: 5rem; line-height: 1; font-weight: 900; text-shadow: var(--glow-text); }
  .turn-x #big-mark { color: #d93a3a; }
  .turn-o #big-mark { color: #3a7bd9; }
  
  body.stranger-theme .turn-x #big-mark { color: #ff0000; }
  body.stranger-theme .turn-o #big-mark { color: #fff; }
  body.showgirl-theme .turn-x #big-mark { color: #00c897; }
  body.showgirl-theme .turn-o #big-mark { color: #ff9100; }

  #timer-container { 
    width: 100%; display: flex; flex-direction: column; align-items: center; 
    margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--line-thin); 
  }
  .timer-row { display: flex; justify-content: center; align-items: center; gap: 12px; }
  #timer-display { font-family: var(--font-ui); font-variant-numeric: tabular-nums; font-size: 1.2rem; font-weight: 600; color: var(--nyt-black); text-shadow: var(--glow-text); }
  
  /* CIRCULAR CONTROLS */
  .control-btn {
    background: var(--board-bg); border: 1px solid var(--line-med); width: 32px; height: 32px;
    border-radius: 50%; display: flex; justify-content: center; align-items: center;
    cursor: pointer; color: var(--nyt-black); transition: all 0.2s; user-select: none;
    position: relative;
    font-size: 1.2rem;
    line-height: 1;
    z-index: 2;
  }
  .control-btn:hover { background: var(--nyt-black); color: var(--bg-color); border-color: var(--nyt-black); }
  
  /* PAUSE ICON SHAPE */
  #pause-btn::after {
    content: ''; display: block; width: 4px; height: 12px;
    background-color: currentColor; box-shadow: 6px 0 0 0 currentColor; transform: translateX(-3px);
  }

  /* SOUND BUTTON */
  #sound-btn { }

  #log-wrapper { width: 100%; flex-grow: 1; overflow: hidden; display: flex; flex-direction: column; margin-bottom: 20px; }
  #activity-log { width: 100%; overflow-y: auto; padding-right: 4px; scrollbar-width: thin; scrollbar-color: var(--line-med) transparent; }
  #activity-log::-webkit-scrollbar { width: 4px; }
  #activity-log::-webkit-scrollbar-thumb { background-color: var(--line-med); border-radius: 4px; }
  
  .log-entry { font-size: 0.85rem; color: var(--text-subtle); padding: 8px 0; border-bottom: 1px solid var(--line-thin); animation: slideIn 0.3s ease; display: flex; align-items: center; gap: 8px; text-shadow: var(--glow-text); }
  @keyframes slideIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
  .log-mark { font-weight: 800; font-family: var(--font-title); font-size: 0.9rem; }
  .log-x { color: #d93a3a; }
  .log-o { color: #3a7bd9; }
  
  body.stranger-theme .log-x { color: #ff0000; }
  body.stranger-theme .log-o { color: #fff; }
  body.showgirl-theme .log-x { color: #00c897; }
  body.showgirl-theme .log-o { color: #ff9100; }

  #sidebar-actions { width: 100%; display: flex; flex-direction: column; gap: 0; margin-top: auto; align-items: center; }
  #bottom-controls { width: 100%; display: flex; justify-content: center; margin-bottom: 10px; }
</style>
</head>
<body>

<div id="start-screen" class="screen">
  <div id="title">Tic Tac Toe<sup>3</sup></div>
  <button id="main-play-btn" class="pill-btn">Play</button>
</div>

<div id="mode-screen" class="screen hidden">
  <h2>Select Mode</h2>
  <div class="mode-options">
    <button id="friend-mode-btn" class="pill-btn">Play a Friend</button>
    <button id="computer-mode-btn" class="pill-btn">Play Computer</button>
    <button id="themes-menu-btn" class="pill-btn secondary-btn" style="padding:10px 30px; font-size:0.9rem;">Themes</button>
  </div>
</div>

<div id="themes-screen" class="screen hidden">
  <h2>Select Theme</h2>
  <div class="mode-options">
    <button class="select-btn theme-btn selected" onclick="setTheme('light')" id="btn-theme-light">Light Mode</button>
    <button class="select-btn theme-btn" onclick="setTheme('dark')" id="btn-theme-dark">Dark Mode</button>
    <button class="select-btn theme-btn" onclick="setTheme('stranger')" id="btn-theme-stranger">Stranger Things</button>
    <button class="select-btn theme-btn" onclick="setTheme('showgirl')" id="btn-theme-showgirl">The Life of a Showgirl</button>
  </div>
  <button id="themes-back-btn" class="pill-btn secondary-btn" style="margin-top:30px;">Back</button>
</div>

<div id="settings-screen" class="screen hidden">
  <h2>Game Settings</h2>
  <div class="settings-group">
    <span class="settings-label">Play As</span>
    <div class="option-row">
      <button class="select-btn side-btn selected" onclick="selectSide('X')" id="btn-side-x">X (First)</button>
      <button class="select-btn side-btn" onclick="selectSide('O')" id="btn-side-o">O (Second)</button>
    </div>
  </div>
  <div class="settings-group">
    <span class="settings-label">Difficulty</span>
    <div class="option-row">
      <button class="select-btn diff-btn selected" onclick="selectDifficulty('easy')" id="btn-diff-easy">Easy</button>
      <button class="select-btn diff-btn" onclick="selectDifficulty('medium')" id="btn-diff-medium">Medium</button>
      <button class="select-btn diff-btn" onclick="selectDifficulty('hard')" id="btn-diff-hard">Hard</button>
      <button class="select-btn diff-btn" onclick="selectDifficulty('expert')" id="btn-diff-expert">Stephanie The Expert</button>
    </div>
  </div>
  <button id="start-game-btn" class="pill-btn">Start Game</button>
  <button id="settings-back-btn" class="pill-btn secondary-btn" style="margin-top:10px;">Back</button>
</div>

<div id="pause-screen" class="modal-overlay">
  <div class="big-pause-icon"></div>
  <div class="label-text">Game Paused</div>
  <div id="paused-time">00:00</div>
  <button id="resume-btn" class="pill-btn" style="margin-top: 30px;">Resume</button>
</div>

<div id="confirm-modal" class="modal-overlay">
  <h2 style="font-family:var(--font-title); font-size:2.5rem; margin-bottom:15px; color:var(--nyt-black);">Clear Board?</h2>
  <p style="color:var(--text-subtle); margin-bottom:30px;">This will wipe your current progress.</p>
  <div style="display:flex; gap:15px;">
    <button id="confirm-yes-btn" class="pill-btn" style="background:#d93a3a; color:white; min-width:120px;">Yes, Clear</button>
    <button id="confirm-no-btn" class="pill-btn secondary-btn" style="min-width:120px;">Cancel</button>
  </div>
</div>

<div id="win-screen" class="modal-overlay">
  <div class="label-text">Winner</div>
  <div id="win-title">X Wins!</div>
  <div style="display:flex; gap: 20px;">
    <button id="play-again-btn" class="pill-btn">Play Again</button>
    <button id="view-board-btn" class="pill-btn secondary-btn">View Board</button>
  </div>
</div>

<div id="game-wrapper">
  <div id="board-container">
    <div id="col-labels" class="label-strip"></div>
    <div id="row-labels" class="label-strip"></div>
    <div id="board"></div>
  </div>
  
  <div id="sidebar">
    <div id="turn-display-container" class="turn-x">
      <div class="label-text">Current Turn</div>
      <div id="big-mark">X</div>
    </div>

    <div id="timer-container">
      <div class="label-text">Timer</div>
      <div class="timer-row">
        <div id="timer-display">00:00</div>
        <button id="pause-btn" class="control-btn" title="Pause"></button>
      </div>
    </div>

    <div id="log-wrapper">
      <div class="label-text" style="text-align: left; border-bottom: 1px solid var(--line-thin); padding-bottom: 5px;">Move History</div>
      <div id="activity-log"></div>
    </div>

    <div id="sidebar-actions">
      <div id="bottom-controls">
        <button id="sound-btn" class="control-btn" title="Toggle Sound">ðŸ”Š</button>
      </div>
      <button id="menu-btn" class="action-btn">Main Menu</button>
      <button id="clear-btn" class="action-btn danger-btn">Clear Board</button>
    </div>
  </div>
</div>

<script>
/* --- DOM ELEMENTS --- */
const startScreen = document.getElementById("start-screen");
const modeScreen = document.getElementById("mode-screen");
const settingsScreen = document.getElementById("settings-screen");
const themesScreen = document.getElementById("themes-screen");
const winScreen = document.getElementById("win-screen");
const pauseScreen = document.getElementById("pause-screen");
const confirmModal = document.getElementById("confirm-modal");
const gameWrapper = document.getElementById("game-wrapper");
const board = document.getElementById("board");
const colLabels = document.getElementById("col-labels");
const rowLabels = document.getElementById("row-labels");

const mainPlayBtn = document.getElementById("main-play-btn");
const friendModeBtn = document.getElementById("friend-mode-btn");
const computerModeBtn = document.getElementById("computer-mode-btn");
const themesMenuBtn = document.getElementById("themes-menu-btn");
const themesBackBtn = document.getElementById("themes-back-btn");
const startGameBtn = document.getElementById("start-game-btn");
const settingsBackBtn = document.getElementById("settings-back-btn");
const playAgainBtn = document.getElementById("play-again-btn");
const viewBoardBtn = document.getElementById("view-board-btn");
const pauseBtn = document.getElementById("pause-btn");
const resumeBtn = document.getElementById("resume-btn");
const soundBtn = document.getElementById("sound-btn"); 

const menuBtn = document.getElementById("menu-btn");
const clearBtn = document.getElementById("clear-btn");
const confirmYesBtn = document.getElementById("confirm-yes-btn");
const confirmNoBtn = document.getElementById("confirm-no-btn");

const turnContainer = document.getElementById("turn-display-container");
const bigMark = document.getElementById("big-mark");
const winTitle = document.getElementById("win-title");
const activityLog = document.getElementById("activity-log");
const timerDisplay = document.getElementById("timer-display");
const pausedTimeDisplay = document.getElementById("paused-time");

/* --- STATE --- */
let turn = "X";
let nextMoveConstraint = null; 
let isGameOver = false;
let isVsComputer = false;
let isPaused = false;
let isMuted = false; 
let currentTheme = 'light';
const cells = [];
let middleGridState = new Array(81).fill(null);
let bigGridState = new Array(9).fill(null);
let moveHistoryData = []; 

let playerSide = "X";
let computerDifficulty = "easy";
let timerInterval = null;
let secondsElapsed = 0;

const SAVE_KEY = 'tictactoe3_save';

/* --- SOUND ENGINE --- */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function playSound(type) {
  if (isMuted) return;
  if (audioCtx.state === 'suspended') audioCtx.resume();

  const oscillator = audioCtx.createOscillator();
  const gainNode = audioCtx.createGain();

  oscillator.connect(gainNode);
  gainNode.connect(audioCtx.destination);

  if (type === 'X') {
    oscillator.type = 'sine';
    oscillator.frequency.setValueAtTime(600, audioCtx.currentTime);
    oscillator.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.15);
    gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
    oscillator.start();
    oscillator.stop(audioCtx.currentTime + 0.15);
  } else {
    oscillator.type = 'sine';
    oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
    oscillator.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.1);
    gainNode.gain.setValueAtTime(0.08, audioCtx.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
    oscillator.start();
    oscillator.stop(audioCtx.currentTime + 0.1);
  }
}

// "Boop" Click Sound
function playButtonSound() {
  if (isMuted) return;
  if (audioCtx.state === 'suspended') audioCtx.resume();
  
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  
  osc.type = 'sine';
  osc.frequency.setValueAtTime(330, audioCtx.currentTime); 
  gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
  
  osc.start();
  osc.stop(audioCtx.currentTime + 0.1);
}

function playWinHum() {
  if (isMuted) return;
  if (audioCtx.state === 'suspended') audioCtx.resume();

  const frequencies = [523.25, 659.25, 783.99]; 
  frequencies.forEach(freq => {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = 'sine';
    osc.frequency.value = freq;
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    
    const now = audioCtx.currentTime;
    gain.gain.setValueAtTime(0, now);
    gain.gain.linearRampToValueAtTime(0.05, now + 0.1); 
    gain.gain.exponentialRampToValueAtTime(0.001, now + 1.5); 
    
    osc.start(now);
    osc.stop(now + 1.5);
  });
}

soundBtn.addEventListener("click", () => {
  isMuted = !isMuted;
  if (isMuted) {
    soundBtn.textContent = "ðŸ”‡";
  } else {
    soundBtn.textContent = "ðŸ”Š";
  }
  saveGame(); 
});

document.querySelectorAll('button').forEach(btn => {
  if(btn.id !== 'sound-btn') {
    btn.addEventListener('click', playButtonSound);
  }
});

/* --- INIT --- */
window.addEventListener('load', () => {
  const savedData = localStorage.getItem(SAVE_KEY);
  if (savedData) {
    loadGameState(JSON.parse(savedData));
  }
});

/* --- THEME LOGIC --- */
function setTheme(theme) {
  currentTheme = theme;
  document.body.classList.remove('dark-theme', 'stranger-theme', 'showgirl-theme');
  if (theme !== 'light') document.body.classList.add(theme + '-theme');
  
  document.querySelectorAll('.theme-btn').forEach(btn => btn.classList.remove('selected'));
  document.getElementById(`btn-theme-${theme}`).classList.add('selected');
  saveGame();
}

/* --- NAVIGATION --- */
mainPlayBtn.addEventListener("click", () => {
  startScreen.classList.add("hidden");
  modeScreen.classList.remove("hidden");
  if (audioCtx.state === 'suspended') audioCtx.resume();
});

themesMenuBtn.addEventListener("click", () => {
  modeScreen.classList.add("hidden");
  themesScreen.classList.remove("hidden");
});

themesBackBtn.addEventListener("click", () => {
  themesScreen.classList.add("hidden");
  modeScreen.classList.remove("hidden");
});

friendModeBtn.addEventListener("click", () => {
  isVsComputer = false;
  modeScreen.classList.add("hidden");
  launchGame();
});

computerModeBtn.addEventListener("click", () => {
  isVsComputer = true;
  modeScreen.classList.add("hidden");
  settingsScreen.classList.remove("hidden");
});

settingsBackBtn.addEventListener("click", () => {
  settingsScreen.classList.add("hidden");
  modeScreen.classList.remove("hidden");
});

function selectSide(side) {
  playerSide = side;
  document.querySelectorAll('.side-btn').forEach(btn => btn.classList.remove('selected'));
  document.getElementById(`btn-side-${side.toLowerCase()}`).classList.add('selected');
}

function selectDifficulty(diff) {
  computerDifficulty = diff;
  document.querySelectorAll('.diff-btn').forEach(btn => btn.classList.remove('selected'));
  document.getElementById(`btn-diff-${diff}`).classList.add('selected');
}

startGameBtn.addEventListener("click", () => {
  settingsScreen.classList.add("hidden");
  launchGame();
});

function launchGame() {
  startTimer();
  setTimeout(() => {
    gameWrapper.style.opacity = "1";
    if (isVsComputer && playerSide === "O") {
       setTimeout(makeComputerMove, 800);
    }
    updateBoardVisuals(); 
    saveGame();
  }, 200);
}

menuBtn.addEventListener("click", () => {
  saveGame(); 
  stopTimer();
  gameWrapper.style.opacity = "0";
  setTimeout(() => {
    startScreen.classList.remove("hidden");
  }, 200);
});

clearBtn.addEventListener("click", () => confirmModal.classList.add("active"));
confirmNoBtn.addEventListener("click", () => confirmModal.classList.remove("active"));
confirmYesBtn.addEventListener("click", () => {
  confirmModal.classList.remove("active");
  resetGame(false); 
});

playAgainBtn.addEventListener("click", () => resetGame(false));
viewBoardBtn.addEventListener("click", () => {
  winScreen.classList.remove("active");
  stopTimer();
});

pauseBtn.addEventListener("click", togglePause);
resumeBtn.addEventListener("click", togglePause);

function togglePause() {
  if (isGameOver) return;
  isPaused = !isPaused;
  if (isPaused) {
    stopTimer();
    pausedTimeDisplay.textContent = timerDisplay.textContent;
    pauseScreen.classList.add("active");
  } else {
    startTimer(true);
    pauseScreen.classList.remove("active");
  }
}

function startTimer(resuming = false) {
  if (!resuming) {
    updateTimerDisplay();
  }
  if (timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    secondsElapsed++;
    updateTimerDisplay();
    saveGame();
  }, 1000);
}

function stopTimer() {
  if (timerInterval) clearInterval(timerInterval);
  timerInterval = null;
}

function updateTimerDisplay() {
  const m = Math.floor(secondsElapsed / 60);
  const s = secondsElapsed % 60;
  timerDisplay.textContent = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
}

for (let i = 0; i < 27 * 27; i++) {
  const cell = document.createElement("div");
  cell.className = "cell legal-zone"; 
  cell.dataset.index = i;
  const row = Math.floor(i / 27);
  const col = i % 27;
  cell.dataset.row = row;
  cell.dataset.col = col;

  if ((col + 1) % 9 === 0) cell.classList.add("b-right-thick");
  else if ((col + 1) % 3 === 0) cell.classList.add("b-right-med");
  if ((row + 1) % 9 === 0) cell.classList.add("b-bottom-thick");
  else if ((row + 1) % 3 === 0) cell.classList.add("b-bottom-med");

  board.appendChild(cell);
  cells.push(cell);
  cell.addEventListener("click", () => handleMove(cell, row, col));
}

for (let i = 1; i <= 27; i++) {
  const colNum = document.createElement("div"); colNum.textContent = i; colLabels.appendChild(colNum);
  const rowNum = document.createElement("div"); rowNum.textContent = i; rowLabels.appendChild(rowNum);
}

function handleMove(cell, row, col) {
  if (isGameOver || isPaused) return; 
  if (isVsComputer && turn !== playerSide) return;
  if (cell.textContent !== "") return;
  if (!isMoveLegal(row, col)) return;

  executeMove(cell, row, col);

  if (isVsComputer && !isGameOver && turn !== playerSide) {
    setTimeout(makeComputerMove, 600);
  }
}

function executeMove(cell, row, col) {
  addLogEntry(turn, row, col);
  
  playSound(turn);

  cell.textContent = turn;
  applyMarkStyles(cell);

  let wonSomething = false;
  if (checkMiddleGridWin(row, col)) {
    wonSomething = true;
    const mgRow = Math.floor(row / 3);
    const mgCol = Math.floor(col / 3);
    const bgRow = Math.floor(mgRow / 3);
    const bgCol = Math.floor(mgCol / 3);
    if (checkBigGridWin(bgRow, bgCol)) checkGlobalWin();
  }

  if (isGameOver) { 
    stopTimer(); 
    updateBoardVisuals(); 
    saveGame();
    return; 
  }
  
  if (wonSomething) nextMoveConstraint = null; 
  else calculateNextConstraint(row, col);

  switchTurn();
  updateBoardVisuals();
  saveGame();
}

function makeComputerMove() {
  if (isGameOver || isPaused) return;

  const legalCells = cells.filter(cell => {
    const r = parseInt(cell.dataset.row);
    const c = parseInt(cell.dataset.col);
    return cell.textContent === "" && isMoveLegal(r, c);
  });

  if (legalCells.length === 0) return;

  let chosenCell = null;
  const computerMark = (playerSide === "X") ? "O" : "X";
  let smartMoveChance = 0; 
  if (computerDifficulty === "easy") smartMoveChance = 0;
  if (computerDifficulty === "medium") smartMoveChance = 0.5;
  if (computerDifficulty === "hard") smartMoveChance = 0.9;
  if (computerDifficulty === "expert") smartMoveChance = 1.0;

  if (Math.random() < smartMoveChance) {
    chosenCell = findBestMoveFor(legalCells, computerMark);
    if (!chosenCell) chosenCell = findBestMoveFor(legalCells, playerSide);
    if (!chosenCell && computerDifficulty === "expert") {
       chosenCell = legalCells.find(cell => {
         const r = parseInt(cell.dataset.row);
         const c = parseInt(cell.dataset.col);
         return (r % 3 === 1) && (c % 3 === 1);
       });
    }
  }

  if (!chosenCell) {
    const randomIndex = Math.floor(Math.random() * legalCells.length);
    chosenCell = legalCells[randomIndex];
  }

  const r = parseInt(chosenCell.dataset.row);
  const c = parseInt(chosenCell.dataset.col);
  executeMove(chosenCell, r, c);
}

function findBestMoveFor(legalMoves, markToCheck) {
  for (let cell of legalMoves) {
    const r = parseInt(cell.dataset.row);
    const c = parseInt(cell.dataset.col);
    if (simulatesLocalWin(r, c, markToCheck)) return cell;
  }
  return null;
}

function simulatesLocalWin(r, c, mark) {
  const mgRow = Math.floor(r / 3);
  const mgCol = Math.floor(c / 3);
  const startR = mgRow * 3;
  const startC = mgCol * 3;
  let localGrid = [[null,null,null],[null,null,null],[null,null,null]];
  for(let i=0; i<3; i++) {
    for(let j=0; j<3; j++) {
      const idx = (startR+i)*27 + (startC+j);
      localGrid[i][j] = cells[idx].textContent;
    }
  }
  localGrid[r%3][c%3] = mark;
  for(let i=0; i<3; i++) if(localGrid[i][0]==mark && localGrid[i][1]==mark && localGrid[i][2]==mark) return true;
  for(let i=0; i<3; i++) if(localGrid[0][i]==mark && localGrid[1][i]==mark && localGrid[2][i]==mark) return true;
  if(localGrid[0][0]==mark && localGrid[1][1]==mark && localGrid[2][2]==mark) return true;
  if(localGrid[0][2]==mark && localGrid[1][1]==mark && localGrid[2][0]==mark) return true;
  return false;
}

function addLogEntry(player, r, c) {
  moveHistoryData.unshift({ player, r, c });
  renderLogEntry(player, r, c);
}

function renderLogEntry(player, r, c) {
  const entry = document.createElement("div");
  entry.className = "log-entry";
  const x = c + 1;
  const y = r + 1;
  const markSpan = `<span class="log-mark ${player === 'X' ? 'log-x' : 'log-o'}">${player}</span>`;
  entry.innerHTML = `${markSpan} placed at <strong>(${x}, ${y})</strong>`;
  activityLog.insertBefore(entry, activityLog.firstChild);
}

function isMoveLegal(r, c) {
  if (isGameOver) return false;
  const mgRow = Math.floor(r / 3);
  const mgCol = Math.floor(c / 3);
  const mgIndex = mgRow * 9 + mgCol;
  const bgRow = Math.floor(mgRow / 3);
  const bgCol = Math.floor(mgCol / 3);
  const bgIndex = bgRow * 3 + bgCol;

  if (middleGridState[mgIndex] !== null) return false;
  if (bigGridState[bgIndex] !== null) return false;

  if (!nextMoveConstraint) return true;
  const { r: rRange, c: cRange } = nextMoveConstraint;
  return (r >= rRange[0] && r < rRange[1] && c >= cRange[0] && c < cRange[1]);
}

function checkMiddleGridWin(r, c) {
  const mgRow = Math.floor(r / 3);
  const mgCol = Math.floor(c / 3);
  const mgIndex = mgRow * 9 + mgCol;
  if (middleGridState[mgIndex] !== null) return false;
  const startR = mgRow * 3;
  const startC = mgCol * 3;
  const getCell = (dr, dc) => cells[(startR + dr) * 27 + (startC + dc)].textContent;
  const winner = checkGridLogic(getCell);
  if (winner) {
    middleGridState[mgIndex] = winner;
    createOverlay(mgRow, mgCol, winner, "middle");
    playWinHum();
    return true;
  }
  return false;
}

function checkBigGridWin(bgRow, bgCol) {
  const bgIndex = bgRow * 3 + bgCol;
  if (bigGridState[bgIndex] !== null) return false;
  const startMgRow = bgRow * 3;
  const startMgCol = bgCol * 3;
  const getMgOwner = (dr, dc) => middleGridState[(startMgRow + dr) * 9 + (startMgCol + dc)];
  const winner = checkGridLogic(getMgOwner);
  if (winner) {
    bigGridState[bgIndex] = winner;
    createOverlay(bgRow, bgCol, winner, "big");
    playWinHum();
    return true;
  }
  return false;
}

function checkGlobalWin() {
  const getBgOwner = (dr, dc) => bigGridState[dr * 3 + dc];
  const winner = checkGridLogic(getBgOwner);
  if (winner) {
    isGameOver = true;
    winTitle.textContent = `${winner} Wins!`;
    winTitle.className = winner === "X" ? "winner-X" : "winner-O";
    winScreen.classList.add("active");
  }
}

function checkGridLogic(accessorFn) {
  const lines = [
    [[0,0], [0,1], [0,2]], [[1,0], [1,1], [1,2]], [[2,0], [2,1], [2,2]], 
    [[0,0], [1,0], [2,0]], [[0,1], [1,1], [2,1]], [[0,2], [1,2], [2,2]], 
    [[0,0], [1,1], [2,2]], [[0,2], [1,1], [2,0]] 
  ];
  for (let line of lines) {
    const v0 = accessorFn(line[0][0], line[0][1]);
    const v1 = accessorFn(line[1][0], line[1][1]);
    const v2 = accessorFn(line[2][0], line[2][1]);
    if (v0 && v0 === v1 && v0 === v2) return v0;
  }
  return null;
}

function calculateNextConstraint(lastRow, lastCol) {
  const middleGridRowVal = Math.floor((lastRow % 9) / 3);
  const middleGridColVal = Math.floor((lastCol % 9) / 3);
  const cellRowVal = lastRow % 3;
  const cellColVal = lastCol % 3;
  const targetBigRow = middleGridRowVal;
  const targetBigCol = middleGridColVal;
  const targetMidRow = cellRowVal;
  const targetMidCol = cellColVal;
  const startRow = (targetBigRow * 9) + (targetMidRow * 3);
  const startCol = (targetBigCol * 9) + (targetMidCol * 3);
  const targetMgRow = (targetBigRow * 3) + targetMidRow;
  const targetMgCol = (targetBigCol * 3) + targetMidCol;
  const targetMgIndex = targetMgRow * 9 + targetMgCol;
  const targetBgIndex = targetBigRow * 3 + targetBigCol;

  nextMoveConstraint = { r: [startRow, startRow + 3], c: [startCol, startCol + 3] };
  if (middleGridState[targetMgIndex] !== null) { nextMoveConstraint = null; return; }
  if (bigGridState[targetBgIndex] !== null) { nextMoveConstraint = null; return; }
  if (isZoneFull(nextMoveConstraint)) { nextMoveConstraint = null; }
}

function isZoneFull(constraint) {
  for (let r = constraint.r[0]; r < constraint.r[1]; r++) {
    for (let c = constraint.c[0]; c < constraint.c[1]; c++) {
      if (cells[r * 27 + c].textContent === "") return false;
    }
  }
  return true;
}

function updateBoardVisuals() {
  cells.forEach(cell => {
    const r = parseInt(cell.dataset.row);
    const c = parseInt(cell.dataset.col);
    if (isGameOver || cell.textContent !== "") {
      cell.className = "cell"; 
      if(cell.textContent) applyMarkStyles(cell);
      restoreBorders(cell, r, c);
    } else if (isMoveLegal(r, c) && !isPaused) {
      cell.className = "cell legal-zone";
      restoreBorders(cell, r, c);
    } else {
      cell.className = "cell disabled-zone";
      restoreBorders(cell, r, c);
    }
  });
}

function restoreBorders(cell, r, c) {
  if ((c + 1) % 9 === 0) cell.classList.add("b-right-thick");
  else if ((c + 1) % 3 === 0) cell.classList.add("b-right-med");
  if ((r + 1) % 9 === 0) cell.classList.add("b-bottom-thick");
  else if ((r + 1) % 3 === 0) cell.classList.add("b-bottom-med");
}

function switchTurn() {
  turn = turn === "X" ? "O" : "X";
  bigMark.textContent = turn;
  turnContainer.className = turn === "X" ? "turn-x" : "turn-o";
}

function applyMarkStyles(cell) {
  cell.classList.remove("x-mark", "o-mark");
  if (cell.textContent === "X") cell.classList.add("x-mark");
  if (cell.textContent === "O") cell.classList.add("o-mark");
}

function createOverlay(row, col, winner, type) {
  const overlay = document.createElement("div");
  overlay.className = `won-overlay winner-${winner}`;
  overlay.textContent = winner;
  if (type === "middle") {
    overlay.classList.add("won-middle-grid");
    const sizePct = 100 / 9; 
    overlay.style.width = `${sizePct}%`; overlay.style.height = `${sizePct}%`;
    overlay.style.top = `${row * sizePct}%`; overlay.style.left = `${col * sizePct}%`;
  } else {
    overlay.classList.add("won-big-grid");
    const sizePct = 100 / 3; 
    overlay.style.width = `${sizePct}%`; overlay.style.height = `${sizePct}%`;
    overlay.style.top = `${row * sizePct}%`; overlay.style.left = `${col * sizePct}%`;
  }
  board.appendChild(overlay);
}

function saveGame() {
  const cellData = cells.map(c => c.textContent);
  const gameState = {
    turn,
    nextMoveConstraint,
    isGameOver,
    isVsComputer,
    playerSide,
    computerDifficulty,
    middleGridState,
    bigGridState,
    secondsElapsed,
    moveHistoryData,
    cellData,
    currentTheme,
    isMuted
  };
  localStorage.setItem(SAVE_KEY, JSON.stringify(gameState));
}

function loadGameState(state) {
  turn = state.turn;
  nextMoveConstraint = state.nextMoveConstraint;
  isGameOver = state.isGameOver;
  isVsComputer = state.isVsComputer;
  playerSide = state.playerSide || "X";
  computerDifficulty = state.computerDifficulty || "easy";
  middleGridState = state.middleGridState;
  bigGridState = state.bigGridState;
  secondsElapsed = state.secondsElapsed;
  moveHistoryData = state.moveHistoryData || [];
  isMuted = state.isMuted || false;
  if(isMuted) soundBtn.textContent = "ðŸ”‡";
  
  if (state.currentTheme) setTheme(state.currentTheme);

  const cellData = state.cellData;
  cells.forEach((cell, i) => {
    cell.textContent = cellData[i];
    applyMarkStyles(cell);
  });

  document.querySelectorAll(".won-overlay").forEach(o => o.remove()); 
  for(let i=0; i<81; i++) {
    if(middleGridState[i]) {
      const r = Math.floor(i / 9);
      const c = i % 9;
      createOverlay(r, c, middleGridState[i], "middle");
    }
  }
  for(let i=0; i<9; i++) {
    if(bigGridState[i]) {
      const r = Math.floor(i / 3);
      const c = i % 3;
      createOverlay(r, c, bigGridState[i], "big");
    }
  }

  activityLog.innerHTML = "";
  for(let i = moveHistoryData.length - 1; i >= 0; i--) {
    const move = moveHistoryData[i];
    renderLogEntry(move.player, move.r, move.c);
  }

  startScreen.classList.add("hidden");
  gameWrapper.style.opacity = "1";
  bigMark.textContent = turn;
  turnContainer.className = turn === "X" ? "turn-x" : "turn-o";
  updateTimerDisplay();
  updateBoardVisuals();
  
  if(!isGameOver) startTimer(true);
}

function resetGame(returnToMenu = false) {
  stopTimer(); 
  localStorage.removeItem(SAVE_KEY); 
  
  turn = "X";
  nextMoveConstraint = null;
  isGameOver = false;
  isPaused = false;
  middleGridState.fill(null);
  bigGridState.fill(null);
  secondsElapsed = 0;
  moveHistoryData = [];
  
  cells.forEach(cell => {
    cell.textContent = "";
    cell.className = "cell legal-zone";
    const r = parseInt(cell.dataset.row);
    const c = parseInt(cell.dataset.col);
    restoreBorders(cell, r, c);
  });
  
  document.querySelectorAll(".won-overlay").forEach(o => o.remove());
  activityLog.innerHTML = "";
  winScreen.classList.remove("active");
  pauseScreen.classList.remove("active");
  
  bigMark.textContent = "X";
  turnContainer.className = "turn-x";
  updateTimerDisplay();

  if (returnToMenu) {
    settingsScreen.classList.add("hidden"); 
    modeScreen.classList.add("hidden");
    gameWrapper.style.opacity = "0";
    setTimeout(() => {
      startScreen.classList.remove("hidden");
    }, 200);
  } else {
    updateBoardVisuals();
    startTimer();
  }
}
</script>

</body>
</html>
